{% extends 'base.html' %}

{% block content %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
     <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <title>User Management</title>

</head>
<body>
    <div class="container">
    <h1>User Management</h1>
     <a href="{% url 'add_user' %}" class="btn btn-success mb-3">Add User</a>

       <div id="msg" 
     style="display:none; 
            padding: 10px 15px; 
            margin-bottom: 15px; 
            border-radius: 5px; 
            background-color: #f8d7da; 
            color: #721c24; 
            border: 1px solid #f5c6cb; 
            font-weight: 500;">
</div>
     <table class="table table-bordered" id="user_table">
        <thead>
            <tr>
                <th>No</th>
                <th>Username</th>
                <th>Email</th>
                <th>Phone Number</th>
                <th>Gender</th>
                <th>Date Of Birth</th>
                <th>Profile Photo</th>
                <th>Profile Video</th>
                <th>Bio</th>
                <th>Country</th>
                <th>State</th>
                <th>City</th>
                <th>Role</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="user_table"></tbody>
     </table>

     <!-- pagination -->
     <ul id="pagination" class="pagination"></ul>
     </div>

     <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>

    function loadUsers(page=1){
        $.ajax({
            url : '/user/user-list/?page=' + page,
            type : 'GET',
            success : function(data){
                let rows = '';
                data.users.forEach(function(u,index){
                    rows+= `<tr>
                        <td>${u.no}</td>
                        <td>${u.username}</td>
                        <td>${u.email}</td>
                        <td>${u.phone_no}</td>
                        <td>${u.gender}</td>
                        <td>${u.dob}</td>
                        <td>
                        ${u.profile_photo ? `<img src="${u.profile_photo}" width="80" height="80">` : 'No Image'}
                        </td>
                        <td>
                        ${u.profile_video ? 
                            `<video width="120" height="80" controls>
                            <source src="${u.profile_video}" type="video/mp4">
                            Your browser does not support video.
                            </video>` 
                            : 'No Video'}
                        </td>
                        <td>${u.bio}</td>
                        <td>${u.country__name || ''}</td>
                        <td>${u.state__name || ''}</td>
                        <td>${u.city__name || ''}</td>
                        <td>${u.role}</td>
                          <td>
                        <button class="btn btn-sm btn-primary" onclick="editUser(${u.id})">Update</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteUser(${u.id})">Delete</button>
                        </td>
                    </tr>`


                });
                $("#user_table tbody").html(rows);

            let pagBtns = '';
            data.pages.forEach(function(p){
              if(p === data.current){ 
                  pagBtns += `<li class="page-item active"><span class="page-link">${p}</span></li>`; 
              } else { 
                  pagBtns += `<li class="page-item"><button class="page-link" onclick="loadUsers(${p})">${p}</button></li>`; 
              }
          });
            $("#pagination").html(pagBtns);
            }
        });
    }


    function deleteUser(user_id){
        $.ajax({
            url : '/user/delete/' + user_id + '/',
            type : 'POST',
            data : {
                csrfmiddlewaretoken : '{{ csrf_token }}'
            },
            success :function(res){
                if(res.status === "success"){
                    $("#msg").text("Data Deleted")
                    loadUsers()
                }else{
                     $("#msg").text("Error: " + data.error);
                }
            }

        });
    }

function editUser(user_id) {
    window.location.href = '/user/update/' + user_id + '/';
}

    $(document).ready(function(){
        loadUsers();
    });

</script>

</body>
</html>



{% endblock %}