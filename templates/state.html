{% extends 'base.html' %}
{% block content %}


<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<div class="container mt-4">

  <h1 class="mb-4">State Management</h1>

  <!-- Country Select + Input + Buttons -->
  <div class="row g-2 mb-3" style="max-width: 600px;">
    <div class="col-md-4">
      <select id="country" class="form-select">
        <option value="">Select Country</option>
        {% for c in countries %}
          <option value="{{c.id}}">{{c.name}}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-4">
      <input type="text" id="state_name" class="form-control" placeholder="Enter state">
      <input type="hidden" id="edit_id">
    </div>
     <div class="col-auto">
      <button class="btn btn-primary me-2" id="add_state">Add</button>
      <button class="btn btn-success" id="update_state" style="display: none;">Update</button>
      <button class="btn btn-success" id="cancel_update" style="display: none;">Cancel</button>
    </div>
  </div>

  <!-- Message -->
  <p id="message" class="fw-bold text-success"></p>

  <!-- Table -->
  <div class="table-responsive">
    <table class="table table-bordered table-striped text-center align-middle" id="state_table">
      <thead class="table-light">
        <tr>
          <th>Country</th>
          <th>States</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Pagination -->
  <nav>
    <ul class="pagination" id="pagination"></ul>
  </nav>

</div>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
function loadState(page=1){
    $.ajax({
        url: '/state/list/?page=' + page,
        type: 'GET',
        success: function(data){
            let rows = '';
            data.countries.forEach(function(c){
                c.states.forEach(function(s, index){
                    rows += `<tr>
                        ${index === 0 ? `<td rowspan="${c.states.length}">${c.country_name}</td>` : ''}
                        <td id="state_cell_${s.id}">${s.name}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="editState(${s.id}, '${s.name}',${s.country_id})">Update</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteState(${s.id})">Delete</button>
                        </td>
                    </tr>`;
                });
            });
            $('#state_table tbody').html(rows);

            // Pagination (Bootstrap style)
            let pagBtns = '';
            data.pages.forEach(function(p){
                if(p === data.current){
                    pagBtns += `<li class="page-item active"><span class="page-link">${p}</span></li>`;
                } else {
                    pagBtns += `<li class="page-item"><button class="page-link" onclick="loadState(${p})">${p}</button></li>`;
                }
            });
            $('#pagination').html(pagBtns);
        }
    });
}

$('#add_state').click(function(){
    let country_id = $('#country').val();
    let state_name = $('#state_name').val().trim();

    if(!state_name){
        $('#message').text('State Name is required');
        return;
    }
    
    $.ajax({
        url : '/state/add/',
        type : 'POST',
        data : {
            country_id : country_id,
            state_name : state_name,
            csrfmiddlewaretoken: '{{ csrf_token }}'
        },
        success: function(res){
            if(res.status === 'success'){
                $('#message').text('Data Inserted');
                $('#country').val("").prop('selectedIndex', 0)
                $('#state_name').val("")
                loadState();
            }else{
                $('#message').text('Already exists in country');
            }
        }
    });
});

function deleteState(id){
    $.ajax({
        url : '/state/delete/' + id + '/',
        type :'POST',
        data : {
            csrfmiddlewaretoken : '{{ csrf_token }}'
        },
        success : function(res){
            if(res.status == 'success'){
                $("#message").text("Deleted successfully")
                loadState()
            }else{
                alert(res.message)
            }
        },
        error: function(xhr, status, error) {
            alert('An error occurred: ' + error);
        }
    });
}

function editState(id,name,country_id){
    $('#state_name').val(name);
    $('#edit_id').val(id);
    $('#add_state').hide();
    $('#update_state').show();
    $('#message').text("");
    $('#cancel_update').show()
    $('#country').val(country_id)
}

$('#update_state').click(function(){
    let id = $('#edit_id').val();
    let country_id = $('#country').val(); 
    $.ajax({
        url : '/state/edit/' + id + '/',
        type : 'POST',
        data:{
            name: $('#state_name').val(),
            country_id: country_id,
            csrfmiddlewaretoken : '{{ csrf_token }}'
        },
        success :function(res){
            if(res.status === 'success'){
                $('#message').text('Updated Successfully');
                $('#state_name').val('');
                $('#edit_id').val('');
                $('#update_state').hide();
                $('#add_state').show();
                $('#cancel_update').hide()
                $('#country').val("")
                loadState();
            }else{
                $('#message').text(res.message);
            }
        }
    });
});

$("#cancel_update").click(function(){
    $("#state_name").val("")
    $("#edit_id").val("")
    $("#update_state").hide()
    $("#add_state").show()
    $('#cancel_update').hide()
    $('#country').val("").prop('selectedIndex', 0)
});

$(document).ready(function(){
    loadState();
});
</script>

{% endblock %}
