{% extends "base.html" %}

{% block content %}


<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<div class="container mt-4">

  <h1 class="mb-4">City Management</h1>

  <!-- Dropdowns + Input + Buttons -->
  <div class="row mb-3 g-2" style="max-width: 700px;">
    <div class="col">
      <select id="country" class="form-select" onchange="loadStateDropdown()">
        <option value="">Select Country</option>
        {% for c in countries %}
          <option value="{{c.id}}">{{c.name}}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col">
      <select id="state" class="form-select">
        <option value="">Select State</option>
      </select>
    </div>
    <div class="col">
      <input type="text" class="form-control" id="city_name" placeholder="Enter City">
      <input type="hidden" id="edit_id">
    </div>
    <div class="col-auto">
      <button class="btn btn-primary" onclick="addCity()" id="add_city">Add</button>
      <button class="btn btn-success" id="update_city" style="display: none;">Update</button>
      <button class="btn btn-success" id="cancel_update" style="display: none;">Cancel</button>
      <input type="hidden" id="edit_state_id">

    </div>
  </div>

  <!-- Message -->
  <p id="message" class="text-success fw-bold"></p>

  <!-- Table -->
  <div class="table-responsive">
    <table class="table table-bordered table-striped text-center align-middle">
      <thead class="table-light">
        <tr>
          <th>Country</th>
          <th>State</th>
          <th>City</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="cityBody"></tbody>
    </table>
  </div>

  <!-- Pagination -->
  <nav>
    <ul class="pagination" id="pagination"></ul>
  </nav>

</div>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
// Load states dynamically when country changes

function loadStateDropdown(){
  let country_id = $('#country').val();
  if(!country_id){
    $('#state').html('<option value="">Select State</option>');
    return;
  }  
  $.ajax({
    url :'/city/get_states/'+ country_id + '/' ,
    type : 'GET',
    success : function(data){
      let option = '<option value="">Select State</option>';
      data.states.forEach(function(s){
        option+=`<option value="${s.id}">${s.name}</option>`
      });
      $('#state').html(option);

      let editStateId = $('#edit_state_id').val();
      if(editStateId){
        $('#state').val(editStateId);
        $('#edit_state_id').val(""); // clear after use
      }
    }
  });
}

// Load cities with pagination
function loadCities(page=1){
  $.ajax({
    url : '/city/list/?page=' + page,
    type : 'GET',
    success :function(res){
      let rows = '';
      for (let country in res.countries){
        let states = res.countries[country];
        let countryRowSpan = Object.values(states).reduce((a,b)=>a+b.length,0);
        let countryPrinted = false;

        for (let state in states){
          let cities = states[state];
          let stateRowSpan = cities.length;
          let statePrinted = false;

          cities.forEach((city, idx)=>{
            rows += `<tr>`;
            if(!countryPrinted){
              rows += `<td rowspan="${countryRowSpan}">${country}</td>`;
              countryPrinted = true;
            }
            if(!statePrinted){
              rows += `<td rowspan="${stateRowSpan}">${state}</td>`;
              statePrinted = true;
            }
            rows += `<td id="city_name_${city.id}">${city.name}</td>
                     <td>
                        <button class="btn btn-sm btn-primary"onclick="updateCity(${city.id},'${city.name}',${city.state_id},${city.country_id})">Update</button>
                       <button class="btn btn-sm btn-danger" onclick="deleteCity(${city.id})">Delete</button>
                     </td>`;
            rows += `</tr>`;
          });
        }
      }
      $('#cityBody').html(rows);

      // Pagination
      let pagBtns = '';
      res.pages.forEach(function(p){
        if(p === res.current){
          pagBtns += `<li class="page-item active"><span class="page-link">${p}</span></li>`;
        } else {
          pagBtns += `<li class="page-item"><button class="page-link" onclick="loadCities(${p})">${p}</button></li>`;
        }
      });
      $('#pagination').html(pagBtns);
    }
  });
}

// Add city
function addCity(){
  let state_id = $("#state").val();
  let city_name = $('#city_name').val();

  if(!state_id || !city_name){
    $("#message").text("Please select Country, State and enter City name.");
    return;
  }

  $.ajax({
    url : '/city/add/',
    type : 'POST',
    data : {
      state_id: state_id,
      name :city_name,
      csrfmiddlewaretoken : "{{ csrf_token }}"
    },
    success:function(res){
      if(res.status === 'success'){
        $('#city_name').val('')
        $('#message').text("Data Inserted Successfully");
        $("#country").val("").prop('selectedIndex', 0)
        $("#state").val("").prop('selectedIndex', 0)
        loadCities()
      }else{
        $("#message").text(res.message);
      }
    }
  });
}

function updateCity(id,name,state_id,country_id){
  $("#city_name").val(name);
  $("#edit_id").val(id);
  $("#add_city").hide();
  $("#update_city").show();
  $("#message").text("");
  $('#cancel_update').show();
  $('#country').val(country_id).change();
  $('#edit_state_id').val(state_id);
}

// Update button click
$("#update_city").click(function(){
  let id = $('#edit_id').val();
  let state_id = $("#state").val()

  $.ajax({
    url : '/city/edit/' + id + '/',
    type : 'POST',
    data : {
      name : $("#city_name").val(),
      state_id : state_id,
      csrfmiddlewaretoken : "{{ csrf_token }}"
    },
    success : function(res){
      if(res.status === 'success'){
        $("#message").text("Updated successfully");
        $("#city_name").val("");
        $("#add_city").show();
        $('#edit_id').val('');
        $("#update_city").hide();
        $("#cancel_update").hide();
        $("#country").val("").prop('selectedIndex', 0)
        $("#state").val("")
        loadCities()
      }else{
        $('#message').text(res.message);
      }
    }
  });
});


$('#cancel_update').click(function(){
      $("#city_name").val("")
      $("#add_city").show()
      $("#edit_id").val("")
      $("#update_city").hide()
      $("#cancel_update").hide()
      $("#message").text("")
      $("#country").val("")
      $("#state").val("")
});


// Delete city
function deleteCity(id){
  $.ajax({
    url : '/city/delete/' +id+ '/',
    type : 'POST',
    data : {
      csrfmiddlewaretoken : "{{ csrf_token }}"
    },
    success : function(res){
      if(res.status === 'success'){
        $("#message").text("Deleted successfully");
        loadCities()
      }else{
        $("#message").text(res.message);
      }
    }
  });
}

// Initial load
$(document).ready(function(){
  loadCities();
});
</script>

{% endblock %}
