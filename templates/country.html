{% extends "base.html" %}

{% block content %}


<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<div class="container mt-4">

  <h1 class="mb-4">Country Management</h1>

  <!-- Input + Buttons -->
  <div class="input-group mb-3" style="max-width: 400px;">
    <input type="text" class="form-control" placeholder="Add Country" id="country_name">
    <div class="col-auto">
      <button class="btn btn-primary me-2" id="add_country">Add</button>
      <button class="btn btn-success" id="update_country" style="display:none;">Update</button>
      <button class="btn btn-success" id="cancel_update" style="display:none;">Cancel</button>
      <input type="hidden" id="edit_id">
    </div>
  </div>

  <!-- Message -->
  <p id="message" class="text-success fw-bold"></p>

  <!-- Table -->
  <div class="table-responsive">
    <table class="table table-bordered table-striped text-center align-middle" id="country_table">
      <thead class="table-light">
        <tr>
          <th>No</th>
          <th>Name</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Pagination -->
  <nav>
    <ul class="pagination" id="pagination"></ul>
  </nav>

</div>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>    
function loadCountries(page=1){
  $.ajax({
      url: '/countries/list/?page=' + page,
      type: 'GET',
      success : function(data){
          let rows = '';
          data.countries.forEach(function(c){
              rows += `<tr>
                  <td>${c.no}</td>
                  <td id="name_cell_${c.id}">${c.name}</td>
                  <td>
                      <button class="btn btn-sm btn-primary" onclick="editCountry(${c.id}, '${c.name}')">Update</button>
                      <button class="btn btn-sm btn-danger" onclick="deleteCountry(${c.id})">Delete</button>
                  </td>
              </tr>`;
          });
          $("#country_table tbody").html(rows);

          // Pagination (Bootstrap style)
          let pagBtns = '';
          data.pages.forEach(function(p){
              if(p === data.current){ 
                  pagBtns += `<li class="page-item active"><span class="page-link">${p}</span></li>`; 
              } else { 
                  pagBtns += `<li class="page-item"><button class="page-link" onclick="loadCountries(${p})">${p}</button></li>`; 
              }
          });
          $("#pagination").html(pagBtns);
      }
  });
}

$("#add_country").click(function(){
  $.ajax({
      url : '/countries/add/',  
      type : 'POST',
      data : {
          name: $("#country_name").val(),
          csrfmiddlewaretoken: '{{ csrf_token }}'
      },
      success: function(res){
          if(res.status === 'success'){
              $("#message").text("Inserted successfully");
              $('#country_name').val(''); 
              loadCountries();
          }else{
              $("#message").text(res.message);
          }
      }
  });
});


function deleteCountry(id){
  $.post('/countries/delete/' + id + '/', {
      csrfmiddlewaretoken: '{{ csrf_token }}'
  }, function(res){
      if(res.status === 'success'){
          $("#message").text("Deleted successfully");
          loadCountries();
      } else {
          $("#message").text(res.message);
      }
  });
}

function editCountry(id,name){
  $('#country_name').val(name);
  $('#edit_id').val(id);
  $('#add_country').hide();
  $('#update_country').show();
  $('#message').text("");
  $('#cancel_update').show()    
}

$('#update_country').click(function(){
  let id = $("#edit_id").val();
  $.ajax({
      url : '/countries/edit/' + id + '/',
      type : 'POST',
      data : {
          name: $('#country_name').val(),
          csrfmiddlewaretoken: '{{ csrf_token }}'
      },
      success: function(res){
          if(res.status === 'success'){
              $('#message').text("Updated Successfully")
              $('#country_name').val('');
              $('#edit_id').val('');
              $('#add_country').show();
              $('#update_country').hide();
              $('#cancel_update').hide()
              loadCountries();
          }else{
              $("#message").text(res.message);
          }
      }
  });
});


$('#cancel_update').click(function(){
      $("#country_name").val("");
      $('#edit_id').val('');
      $('#update_country').hide();
      $("#add_country").show()
      $('#cancel_update').hide()
});

$(document).ready(function(){
  loadCountries(); 
});
</script>
{% endblock %}
